{% extends "base.html" %}

{% block title %}Замовлення - Smart 3D{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/orders.css?v=10">
{% endblock %}

{% block content %}

<main class="orders-content" style="min-height: 60vh;">
    <div id="verificationMessage"></div>
    <h1>Створити замовлення</h1>
    <form id="orderForm" enctype="multipart/form-data">
        <input type="text" name="description" placeholder="Опис замовлення" required>
        <input type="text" name="color" placeholder="Колір (необов'язково)">
        <input type="text" name="size" placeholder="Розмір (необов'язково)">
        <label>Фото (необов'язково): <input type="file" name="file" accept="image/*"></label>
        <button type="submit">Створити замовлення</button>
    </form>

    <h2>Ваші замовлення</h2>
    <ul id="ordersList"></ul>
</main>

<!-- Modal for Delete Confirmation -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top: 0;">Видалити замовлення?</h3>
        <p>Цю дію неможливо відмінити.</p>
        <div class="modal-actions">
            <button id="cancelBtn" class="modal-btn cancel">Ні, залишити</button>
            <button id="confirmBtn" class="modal-btn confirm">Так, видалити</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById("orderForm");

    // Check user role
    async function checkRole() {
        try {
            const res = await fetch("/me", { credentials: "include" });
            if (res.ok) {
                const user = await res.json();

                // Verification check
                const vMsg = document.getElementById("verificationMessage");
                if (vMsg && !user.is_verified) {
                    vMsg.innerHTML = `
                            <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 12px; border: 1px solid #ffeeba; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                    <div>
                                        <strong>Email не підтверджено!</strong> Будь ласка, перевірте пошту (або розділ сповіщень) для підтвердження акаунту. 
                                        Ви не зможете створювати замовлення до підтвердження.
                                    </div>
                                    <button id="resendBtn" onclick="resendEmail('${user.email}')" style="background: #856404; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; white-space: nowrap;">
                                        Надіслати знову
                                    </button>
                                </div>
                                <div id="resendStatus" style="font-size: 0.9em; margin-top: 10px;"></div>
                            </div>
                        `;
                    if (form) {
                        const btn = form.querySelector("button[type='submit']");
                        if (btn) {
                            btn.disabled = true;
                            btn.style.opacity = "0.5";
                            btn.title = "Будь ласка, спочатку підтвердіть Email";
                        }
                    }
                }

                if (user.role === "admin") {
                    const btn = document.createElement("button");
                    btn.textContent = "Перейти до адмін-панелі";
                    btn.style.cssText = "background: #343a40; margin-bottom: 20px; width: 100%; color: white;";
                    btn.onclick = () => window.location.href = "/admin_page";
                    document.querySelector(".orders-content").insertBefore(btn, document.querySelector(".orders-content").firstChild);
                }
            }
        } catch (e) { console.error(e); }
    }
    checkRole();

    async function resendEmail(email) {
        const btn = document.getElementById("resendBtn");
        const status = document.getElementById("resendStatus");
        if (!btn) return;
        btn.disabled = true;
        status.textContent = "Надсилаємо...";
        status.style.color = "#856404";

        try {
            const formData = new FormData();
            formData.append("email", email);
            const res = await fetch("/resend-verification", { method: "POST", body: formData });
            const data = await res.json();

            if (res.ok) {
                status.textContent = "Посилання надіслано! Перевірте пошту.";
                status.style.color = "#155724";
                // Simple 60s cooldown on UI
                let count = 60;
                const timer = setInterval(() => {
                    count--;
                    if (count <= 0) {
                        clearInterval(timer);
                        btn.disabled = false;
                        btn.textContent = "Надіслати знову";
                    } else {
                        btn.textContent = `Зачекайте ${count}с`;
                    }
                }, 1000);
            } else {
                status.textContent = "Помилка: " + (data.detail || "Невідома помилка");
                status.style.color = "#721c24";
                btn.disabled = false;
            }
        } catch (e) {
            status.textContent = "Помилка мережі";
            status.style.color = "#721c24";
            btn.disabled = false;
        }
    }

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const res = await fetch("/create_order", { method: "POST", body: formData, credentials: "include" });
            const data = await res.json();
            if (res.ok) {
                form.reset();
                loadOrders();
            }
            else alert("Помилка: " + (data.detail || JSON.stringify(data)));
        });
    }

    async function loadOrders() {
        const res = await fetch("/orders", { credentials: "include" });
        const data = await res.json();
        const orders = data.orders || [];
        const list = document.getElementById("ordersList");
        if (!list) return;
        list.innerHTML = "";
        orders.forEach(o => {
            const li = document.createElement("li");

            let metaHtml = "";
            if (o.color) metaHtml += `<span class="badge">Колір: ${o.color}</span>`;
            if (o.size) metaHtml += `<span class="badge">Розмір: ${o.size}</span>`;

            // Status Badge
            const statusMap = {
                "new": "Новий",
                "in progress": "В роботі",
                "done": "Готово",
                "canceled": "Скасовано"
            };
            let statusColor = "status-new";
            if (o.status === "in progress") statusColor = "status-inprogress";
            if (o.status === "done") statusColor = "status-done";
            if (o.status === "canceled") statusColor = "status-canceled";

            let statusTitle = statusMap[o.status] || o.status;

            metaHtml += `<span class="status-badge ${statusColor}">${statusTitle}</span>`;

            // Better date formatting
            let dateStr = "Невідома дата";
            if (o.created_at) {
                const d = new Date(o.created_at);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const hours = String(d.getHours()).padStart(2, '0');
                const mins = String(d.getMinutes()).padStart(2, '0');
                dateStr = `${day}.${month}.${year} ${hours}:${mins}`;
            }

            li.innerHTML = `
                    <div class="order-info">
                        <div><strong style="font-size: 1.2em; color: #4b8f3f;">Замовлення #${o.id}</strong></div>
                        <div style="font-size: 1.1em; margin: 5px 0; font-weight: 500;">${o.description}</div>
                        <div class="meta">
                            ${metaHtml}
                            <span>${dateStr}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        ${o.file_path ? `<a href="/${o.file_path}" target="_blank" style="color: #4b8f3f; text-decoration: none; font-weight: bold;">Файл</a>` : ''}
                        <button onclick="deleteOrder(${o.id})" style="background: #dc3545; color: white; border: none; padding: 8px 15px; font-size: 0.9em; cursor: pointer; border-radius: 8px; font-weight: bold;">Видалити</button>
                    </div>
                `;
            list.appendChild(li);
        });
    }

    let orderIdToDelete = null;
    const modal = document.getElementById("deleteModal");
    const confirmBtn = document.getElementById("confirmBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    if (cancelBtn) cancelBtn.onclick = () => closeModal();
    if (confirmBtn) {
        confirmBtn.onclick = async () => {
            if (orderIdToDelete) {
                await executeDelete(orderIdToDelete);
            }
            closeModal();
        };
    }

    if (modal) {
        modal.onclick = (e) => {
            if (e.target === modal) closeModal();
        };
    }

    function openModal(id) {
        orderIdToDelete = id;
        if (modal) modal.classList.add("active");
    }

    function closeModal() {
        orderIdToDelete = null;
        if (modal) modal.classList.remove("active");
    }

    async function deleteOrder(id) {
        openModal(id);
    }

    async function executeDelete(id) {
        const res = await fetch(`/orders/${id}`, { method: "DELETE", credentials: "include" });
        if (res.ok) {
            loadOrders();
        } else {
            const data = await res.json();
            alert("Помилка видалення: " + (data.detail || JSON.stringify(data)));
        }
    }

    loadOrders();
</script>
{% endblock %}