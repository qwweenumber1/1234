{% extends "base.html" %}

{% block title %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è - Smart 3D{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/orders.css?v=11">
{% endblock %}

{% block content %}

<main class="orders-content" style="min-height: 60vh;">
    <div id="verificationMessage"></div>
    <h1>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    <form id="orderForm" enctype="multipart/form-data" class="advanced-form">
        <input type="text" name="description" placeholder="–û–ø–∏—Å –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–Ω–∞–ø—Ä. –®–µ—Å—Ç–µ—Ä–Ω—è)" required>

        <div class="selection-group">
            <label class="group-label">‚öôÔ∏è –û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª:</label>
            <div class="chip-grid">
                <input type="radio" name="material" value="PLA" id="m_pla" checked required>
                <label for="m_pla" class="chip">PLA<span>200‚Ç¥ min</span></label>

                <input type="radio" name="material" value="ABS" id="m_abs">
                <label for="m_abs" class="chip">ABS<span>200‚Ç¥ min</span></label>

                <input type="radio" name="material" value="PETG" id="m_petg">
                <label for="m_petg" class="chip">PETG<span>200‚Ç¥ min</span></label>

                <input type="radio" name="material" value="TPU" id="m_tpu">
                <label for="m_tpu" class="chip">TPU<span>500‚Ç¥ min</span></label>

                <input type="radio" name="material" value="Nylon" id="m_nylon">
                <label for="m_nylon" class="chip">–ù–µ–π–ª–æ–Ω<span>500‚Ç¥ min</span></label>

                <input type="radio" name="material" value="SLA" id="m_sla">
                <label for="m_sla" class="chip">SLA<span>500‚Ç¥ min</span></label>
            </div>
        </div>

        <div class="selection-group">
            <label class="group-label">üé® –û–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä:</label>
            <div class="chip-grid colors">
                <input type="radio" name="color" value="Black" id="c_black" checked>
                <label for="c_black" class="chip color-chip" style="--bg: #000; --fg: #fff;">–ß–æ—Ä–Ω–∏–π</label>

                <input type="radio" name="color" value="White" id="c_white">
                <label for="c_white" class="chip color-chip" style="--bg: #fff; --fg: #000;">–ë—ñ–ª–∏–π</label>

                <input type="radio" name="color" value="Grey" id="c_grey">
                <label for="c_grey" class="chip color-chip" style="--bg: #888; --fg: #fff;">–°—ñ—Ä–∏–π</label>

                <input type="radio" name="color" value="Red" id="c_red">
                <label for="c_red" class="chip color-chip" style="--bg: #e74c3c; --fg: #fff;">–ß–µ—Ä–≤–æ–Ω–∏–π</label>

                <input type="radio" name="color" value="Blue" id="c_blue">
                <label for="c_blue" class="chip color-chip" style="--bg: #3498db; --fg: #fff;">–°–∏–Ω—ñ–π</label>
            </div>
        </div>

        <div class="form-row">
            <div class="input-wrapper">
                <label>üìç X (–º–º)</label>
                <input type="number" name="width" placeholder="–º–º" min="1" max="500" required>
            </div>
            <div class="input-wrapper">
                <label>üìç Y (–º–º)</label>
                <input type="number" name="length" placeholder="–º–º" min="1" max="500" required>
            </div>
            <div class="input-wrapper">
                <label>üìç Z (–º–º)</label>
                <input type="number" name="height" placeholder="–º–º" min="1" max="500" required>
            </div>
        </div>

        <div class="form-row">
            <div class="input-wrapper">
                <label>üß¨ –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è (%)</label>
                <input type="number" name="infill" placeholder="%" min="0" max="100" value="20">
            </div>
            <div class="input-wrapper">
                <label>‚öñÔ∏è –í–∞–≥–∞ (–≥)</label>
                <input type="number" name="real_weight" placeholder="–≥" min="0" max="10000">
            </div>
        </div>

        <label class="file-label">
            <span>üìÇ –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª –º–æ–¥–µ–ª—ñ</span>
            <input type="file" name="file">
        </label>

        <button type="button" id="previewBtn" class="primary-btn">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
    </form>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-box confirmation-box">
            <h2 style="margin-top: 0; color: #4b8f3f;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h2>
            <p>–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:</p>
            <div id="orderSummary" class="order-summary"></div>
            <div class="price-prediction">
                <span>–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å:</span>
                <strong id="predictedPrice">0</strong> <strong>–≥—Ä–Ω</strong>
            </div>
            <div class="modal-actions">
                <button id="closeConfirmBtn" class="modal-btn cancel">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å</button>
                <button id="finalSubmitBtn" class="modal-btn confirm-action">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
            </div>
        </div>
    </div>

    <h2 style="margin-top: 40px;">–í–∞—à—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
    <ul id="ordersList"></ul>
</main>

<!-- Modal for Delete Confirmation -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="margin-top: 0;">–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?</h3>
        <p>–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏.</p>
        <div class="modal-actions">
            <button id="cancelBtn" class="modal-btn cancel">–ù—ñ, –∑–∞–ª–∏—à–∏—Ç–∏</button>
            <button id="confirmBtn" class="modal-btn confirm">–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById("orderForm");

    // Check user role & verification
    async function checkRole() {
        try {
            const res = await fetch("/me", { credentials: "include" });
            if (res.ok) {
                const user = await res.json();
                const vMsg = document.getElementById("verificationMessage");

                if (vMsg && !user.is_verified) {
                    vMsg.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 12px; border: 1px solid #ffeeba; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <strong>Email –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!</strong> –ë—É–¥—å –ª–∞—Å–∫–∞, –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å Email –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å.
                                </div>
                                <button id="resendBtn" onclick="resendEmail('${user.email}')" style="background: #856404; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                    –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–Ω–æ–≤—É
                                </button>
                            </div>
                            <div id="resendStatus" style="font-size: 0.9em; margin-top: 10px;"></div>
                        </div>
                    `;
                    const pBtn = document.getElementById("previewBtn");
                    if (pBtn) {
                        pBtn.disabled = true;
                        pBtn.style.opacity = "0.5";
                        pBtn.title = "–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å Email";
                    }
                }

                if (user.role === "admin") {
                    const btn = document.createElement("button");
                    btn.textContent = "‚öôÔ∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å";
                    btn.className = "primary-btn";
                    btn.style.cssText = "background: #334155; margin-bottom: 30px; border-radius: 12px;";
                    btn.onclick = () => window.location.href = "/admin_page";
                    document.querySelector(".orders-content").insertBefore(btn, document.querySelector(".orders-content").firstChild);
                }
            }
        } catch (e) { console.error(e); }
    }
    checkRole();

    // Confirmation Logic
    const previewBtn = document.getElementById("previewBtn");
    const confirmModal = document.getElementById("confirmModal");
    const closeConfirmBtn = document.getElementById("closeConfirmBtn");
    const finalSubmitBtn = document.getElementById("finalSubmitBtn");
    const predictedPriceElem = document.getElementById("predictedPrice");
    const orderSummaryElem = document.getElementById("orderSummary");

    if (previewBtn) {
        previewBtn.onclick = async () => {
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const params = new URLSearchParams();
            for (const pair of formData.entries()) {
                if (typeof pair[1] === 'string' && pair[1].trim() !== '') {
                    params.append(pair[0], pair[1]);
                }
            }

            try {
                previewBtn.disabled = true;
                previewBtn.textContent = "‚è≥ –†–∞—Ö—É—î–º–æ...";

                const res = await fetch(`/calculate_price?${params.toString()}`);
                const data = await res.json();

                if (res.ok) {
                    predictedPriceElem.textContent = data.price;

                    const selectedInput = form.querySelector('input[name="material"]:checked');
                    const material = form.querySelector(`label[for="${selectedInput.id}"]`).childNodes[0].textContent.trim();
                    const colorLabel = form.querySelector('input[name="color"]:checked + label').textContent.trim();

                    orderSummaryElem.innerHTML = `
                        <div class="summary-item"><span>–û–ø–∏—Å:</span> <strong>${formData.get('description')}</strong></div>
                        <div class="summary-item"><span>–ú–∞—Ç–µ—Ä—ñ–∞–ª:</span> <strong>${material}</strong></div>
                        <div class="summary-item"><span>–ö–æ–ª—ñ—Ä:</span> <strong>${colorLabel}</strong></div>
                        <div class="summary-item"><span>–†–æ–∑–º—ñ—Ä–∏:</span> <strong>${formData.get('width')}x${formData.get('length')}x${formData.get('height')} –º–º</strong></div>
                        <div class="summary-item"><span>–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è:</span> <strong>${formData.get('infill')}%</strong></div>
                        ${formData.get('real_weight') ? `<div class="summary-item"><span>–í–∞–≥–∞:</span> <strong>${formData.get('real_weight')} –≥</strong></div>` : ''}
                    `;

                    confirmModal.classList.add("active");
                } else {
                    alert("–ü–æ–º–∏–ª–∫–∞: " + (data.detail || "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞"));
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è");
            } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = "–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è";
            }
        };
    }

    if (closeConfirmBtn) closeConfirmBtn.onclick = () => confirmModal.classList.remove("active");

    if (finalSubmitBtn) {
        finalSubmitBtn.onclick = async () => {
            finalSubmitBtn.disabled = true;
            finalSubmitBtn.textContent = "‚åõ –û—Ñ–æ—Ä–º–ª—é—î–º–æ...";

            const formData = new FormData(form);
            try {
                const res = await fetch("/create_order", { method: "POST", body: formData, credentials: "include" });
                if (res.ok) {
                    form.reset();
                    confirmModal.classList.remove("active");
                    loadOrders();
                } else {
                    const data = await res.json();
                    alert("–ü–æ–º–∏–ª–∫–∞: " + (data.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"));
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
            } finally {
                finalSubmitBtn.disabled = false;
                finalSubmitBtn.textContent = "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è";
            }
        };
    }

    // Orders List Logic
    async function loadOrders() {
        const res = await fetch("/orders", { credentials: "include" });
        const data = await res.json();
        const orders = data.orders || [];
        const list = document.getElementById("ordersList");
        if (!list) return;
        list.innerHTML = "";
        orders.sort((a, b) => b.id - a.id).forEach(o => {
            const li = document.createElement("li");

            let metaHtml = "";
            if (o.material) metaHtml += `<span class="badge material-badge">${o.material}</span>`;
            if (o.price) metaHtml += `<span class="badge price-badge">${o.price} –≥—Ä–Ω</span>`;

            const statusMap = { "new": "–ù–æ–≤–∏–π", "pending": "–û—á—ñ–∫—É—î", "in progress": "–í —Ä–æ–±–æ—Ç—ñ", "done": "–ì–æ—Ç–æ–≤–æ", "canceled": "–°–∫–∞—Å–æ–≤–∞–Ω–æ" };
            const statusColors = { "new": "status-new", "pending": "status-pending", "in progress": "status-inprogress", "done": "status-done", "canceled": "status-canceled" };

            metaHtml += `<span class="status-badge ${statusColors[o.status] || 'status-new'}">${statusMap[o.status] || o.status}</span>`;

            let dateStr = o.created_at ? new Date(o.created_at).toLocaleString('uk-UA') : "---";

            li.innerHTML = `
                <div class="order-info">
                    <div><strong style="font-size: 1.1em;">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #${o.id}</strong></div>
                    <div style="margin: 3px 0;">${o.description}</div>
                    <div class="meta">${metaHtml} <span>${dateStr}</span></div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    ${o.file_path ? `<a href="/${o.file_path}" target="_blank" style="color: #4b8f3f; text-decoration: none; font-weight: bold; font-size: 0.9em;">üìÑ –§–∞–π–ª</a>` : ''}
                    <button onclick="deleteOrder(${o.id})" style="background: #fee2e2; color: #dc2626; border: none; padding: 8px 12px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 0.85em;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // Delete Modal Logic
    let orderIdToDelete = null;
    const delModal = document.getElementById("deleteModal");
    function openModal(id) { orderIdToDelete = id; delModal.classList.add("active"); }
    function closeModal() { orderIdToDelete = null; delModal.classList.remove("active"); }
    document.getElementById("cancelBtn").onclick = closeModal;
    document.getElementById("confirmBtn").onclick = async () => {
        if (orderIdToDelete) {
            const res = await fetch(`/orders/${orderIdToDelete}`, { method: "DELETE", credentials: "include" });
            if (res.ok) loadOrders();
            closeModal();
        }
    };

    window.deleteOrder = openModal;
    loadOrders();
</script>
{% endblock %}